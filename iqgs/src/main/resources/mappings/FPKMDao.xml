<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gooalgene.iqgs.dao.FPKMDao">
    <resultMap id="advanceSearchResult" type="com.gooalgene.iqgs.entity.condition.AdvanceSearchResultView">
        <id property="id" column="id" javaType="int" jdbcType="INTEGER"/>
        <result property="geneId" column="gene_id" javaType="String" jdbcType="VARCHAR"/>
        <result property="geneOldId" column="gene_id_old" javaType="String" jdbcType="VARCHAR"/>
        <result property="podAll" column="pod_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="seedAll" column="seed_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="rootAll" column="root_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="shootAll" column="shoot_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="leafAll" column="leaf_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="seedlingAll" column="seedling_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="flowerAll" column="flower_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="stemAll" column="stem_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="geneName" column="gene_name" javaType="String" jdbcType="VARCHAR" />
        <result property="functions" column="description" javaType="String" jdbcType="VARCHAR" />
    </resultMap>

    <select id="findGeneThroughGeneExpressionCondition"
            parameterType="com.gooalgene.iqgs.entity.condition.GeneExpressionConditionEntity"
            resultMap="advanceSearchResult">
        SELECT a.id, a.gene_id, a.pod_All, a.seed_All, a.root_All, a.shoot_All, a.leaf_All, a.seedling_All,
        a.flower_All, a.stem_All, f.gene_name, f.description,
        f.gene_id_old FROM fpkm a
        LEFT JOIN fpkm_associate_snp b ON a.id = b.fpkm_id
        LEFT JOIN snp_consequencetype c ON b.snp_id = c.id
        LEFT JOIN fpkm_associate_indel d ON a.id = d.fpkm_id
        LEFT JOIN indel_consequencetype e ON e.id = d.indel_id
        LEFT JOIN gens_baseinfo f ON a.gene_id = f.gene_id
        LEFT JOIN qtl_gene g ON f.id = g.gene_info_id
        LEFT JOIN associatedgenes h ON h.id = g.qtl_id
        WHERE 1=1
        <if test="geneExpression != null and geneExpression.size() > 0">
            <foreach collection="geneExpression" index="index" item="item">
                <if test="item.tissue.pod != null">
                    AND a.pod BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.endosperm != null">
                    AND a.endosperm BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.seed != null">
                    AND a.seed BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.embryo != null">
                    AND a.embryo BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.axis != null">
                    AND a.axis BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.cotyledon != null">
                    AND a.cotyledon BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.seedCoat != null">
                    AND a.seed_coat BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.nodule != null">
                    AND a.nodule BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.rootHair != null">
                    AND a.root_hair BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.root != null">
                    AND a.root BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.rootTip != null">
                    AND a.root_tip BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.shoot != null">
                    AND a.shoot BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.shootTip != null">
                    AND a.shoot_tip BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.shootApicalMeristem != null">
                    AND a.shoot_apical_meristem BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.shootMeristem != null">
                    AND a.shoot_meristem BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.primaryleaf != null">
                    AND a.primaryleaf BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.petiole != null">
                    AND a.petiole BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.leaf != null">
                    AND a.leaf BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.trifoliate != null">
                    AND a.trifoliate BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.leafbud != null">
                    AND a.leafbud BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.leaflet != null">
                    AND a.leaflet BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.cotyledonsOfSeedling != null">
                    AND a.cotyledons_of_seedling BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.seedling != null">
                    AND a.seedling BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.flowerBud != null">
                    AND a.flower_bud BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.flower != null">
                    AND a.flower BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.stem != null">
                    AND a.stem BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.stemInternode != null">
                    AND a.stem_internode BETWEEN #{item.begin} AND #{item.end}
                </if>
                <if test="item.tissue.hypocotyl != null">
                    AND a.hypocotyl BETWEEN #{item.begin} AND #{item.end}
                </if>
            </foreach>
        </if>
        <if test="snp != null and snp.size() > 0">
            AND c.consequencetype IN
            <foreach collection="snp" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="indel != null and indel.size() > 0">
            AND e.consequencetype IN
            <foreach collection="indel" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="qtl != null and qtl.size() > 0">
            AND h.id IN
            <foreach collection="qtl" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="firstHierarchyQtlId != null and firstHierarchyQtlId.size() > 0">
            AND a.gene_id IN
            (SELECT a.gene_id FROM gens_baseinfo a
            LEFT JOIN qtl_gene b ON a.id = b.gene_info_id
            LEFT JOIN associatedgenes c ON c.id = b.qtl_id
            WHERE c.id in
            <foreach collection="firstHierarchyQtlId" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
            )
        </if>
        GROUP BY a.id, a.gene_id, a.pod_All, a.seed_All, a.root_All, a.shoot_All, a.leaf_All, a.seedling_All, a.flower_All,
        a.stem_All, f.gene_id_old, f.gene_name, f.description
    </select>

    <select id="checkExistSNP" resultType="boolean">
        SELECT exists(SELECT c.consequencetype FROM fpkm a
          LEFT JOIN fpkm_associate_snp b ON a.id = b.fpkm_id
          LEFT JOIN snp_consequencetype c ON c.id = b.snp_id
          WHERE a.id = #{0} AND c.consequencetype = #{1}) as result;
    </select>

</mapper>