<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gooalgene.iqgs.dao.FPKMDao">
    <resultMap id="advanceSearchResult" type="com.gooalgene.iqgs.entity.condition.AdvanceSearchResultView">
        <id property="id" column="id" javaType="int" jdbcType="INTEGER"/>
        <result property="geneId" column="gene_id" javaType="String" jdbcType="VARCHAR"/>
        <result property="geneOldId" column="gene_id_old" javaType="String" jdbcType="VARCHAR"/>
        <result property="podAll" column="pod_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="seedAll" column="seed_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="rootAll" column="root_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="shootAll" column="shoot_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="leafAll" column="leaf_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="seedlingAll" column="seedling_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="flowerAll" column="flower_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="stemAll" column="stem_All" javaType="double" jdbcType="DOUBLE"/>
        <result property="geneName" column="gene_name" javaType="String" jdbcType="VARCHAR"/>
        <result property="functions" column="description" javaType="String" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="advanceSearchSQL">
        SELECT a.gene_id, a.pod_All, a.seed_All, a.root_All, a.shoot_All, a.leaf_All, a.seedling_All,
        a.flower_All, a.stem_All, f.id, f.gene_name, f.description,
        f.gene_id_old FROM fpkm a
        LEFT JOIN fpkm_associate_snp b ON a.id = b.fpkm_id
        LEFT JOIN snp_consequencetype c ON b.snp_id = c.id
        LEFT JOIN fpkm_associate_indel d ON a.id = d.fpkm_id
        LEFT JOIN indel_consequencetype e ON e.id = d.indel_id
        LEFT JOIN gens_baseinfo f ON a.gene_id = f.gene_id
        LEFT JOIN qtl_gene g ON f.id = g.gene_info_id
        LEFT JOIN associatedgenes h ON h.id = g.qtl_id
        LEFT JOIN gens_structure i ON i.gene_id = a.gene_id
        WHERE 1=1
        <if test="geneExpression != null and geneExpression.size() > 0">
            AND (
            <trim suffixOverrides="OR">
                <foreach collection="geneExpression" index="index" item="item">
                    <if test="item.tissue.pod != null">
                        a.pod BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.endosperm != null">
                        a.endosperm BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.seed != null">
                        a.seed BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.embryo != null">
                        a.embryo BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.axis != null">
                        a.axis BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.cotyledon != null">
                        a.cotyledon BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.seedCoat != null">
                        a.seed_coat BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.nodule != null">
                        a.nodule BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.rootHair != null">
                        a.root_hair BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.root != null">
                        a.root BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.rootTip != null">
                        a.root_tip BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.shoot != null">
                        a.shoot BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.shootTip != null">
                        a.shoot_tip BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.shootApicalMeristem != null">
                        a.shoot_apical_meristem BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.shootMeristem != null">
                        a.shoot_meristem BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.primaryleaf != null">
                        a.primaryleaf BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.petiole != null">
                        a.petiole BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.leaf != null">
                        a.leaf BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.trifoliate != null">
                        a.trifoliate BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.leafbud != null">
                        a.leafbud BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.leaflet != null">
                        a.leaflet BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.cotyledonsOfSeedling != null">
                        a.cotyledons_of_seedling BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.seedling != null">
                        a.seedling BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.flowerBud != null">
                        a.flower_bud BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.flower != null">
                        a.flower BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.stem != null">
                        a.stem BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.stemInternode != null">
                        a.stem_internode BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                    <if test="item.tissue.hypocotyl != null">
                        a.hypocotyl BETWEEN #{item.begin} AND #{item.end} OR
                    </if>
                </foreach>
            </trim>
            )
        </if>
        <if test="snp != null and snp.size() > 0">
            AND c.consequencetype IN
            <foreach collection="snp" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="indel != null and indel.size() > 0">
            AND e.consequencetype IN
            <foreach collection="indel" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="qtl != null and qtl.size() > 0">
            AND h.id IN
            <foreach collection="qtl" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </sql>
    <sql id="groupBySQL">
        GROUP BY a.id, a.gene_id, a.pod_All, a.seed_All, a.root_All, a.shoot_All, a.leaf_All, a.seedling_All, a.flower_All,
        a.stem_All, f.id, f.gene_id_old, f.gene_name, f.description
    </sql>

    <select id="findGeneThroughGeneExpressionCondition"
            parameterType="com.gooalgene.iqgs.entity.condition.GeneExpressionConditionEntity"
            resultMap="advanceSearchResult">
        <include refid="advanceSearchSQL"/>
        <if test="firstHierarchyQtlId != null and firstHierarchyQtlId.size() > 0">
            AND f.id IN
            (SELECT a.id FROM gens_baseinfo a
            LEFT JOIN qtl_gene b ON a.id = b.gene_info_id
            LEFT JOIN associatedgenes c ON c.id = b.qtl_id
            WHERE c.id in
            <foreach collection="firstHierarchyQtlId" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
            )
        </if>
        <if test="searchById != null">
            <if test="searchById.geneId != null">
                AND (f.gene_id LIKE CONCAT('%', #{searchById.geneId}, '%') OR f.gene_id_old LIKE CONCAT('%',
                #{searchById.geneId}, '%'))
            </if>
            <if test="searchById.geneName != null">
                AND f.gene_name LIKE CONCAT('%', #{searchById.geneName}, '%')
            </if>
            <if test="searchById.functions != null">
                AND f.description LIKE CONCAT('%', #{searchById.functions}, '%')
            </if>
        </if>
        <if test="structure != null">
            AND i.chromosome = #{structure.chromosome} AND (
            (i.start &gt;#{structure.start} AND i.start &lt;#{structure.end})
            OR
            (i.end &gt;#{structure.start} AND i.end &lt;#{structure.end})
            OR
            (i.start &lt;#{structure.start} AND i.end &gt;#{structure.start})
            )
        </if>
        <include refid="groupBySQL"/>
    </select>

    <select id="fetchFirstHundredGene"
            parameterType="com.gooalgene.iqgs.entity.condition.GeneExpressionConditionEntity"
            resultMap="advanceSearchResult">
        <include refid="advanceSearchSQL"/>
        <if test="geneId != null and geneId.size() > 0">
            AND f.id IN
            <foreach collection="geneId" index="index" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <include refid="groupBySQL"/>
    </select>

    <select id="fetchFirstHundredGeneInGeneStructure"
            resultMap="advanceSearchResult">
        <include refid="advanceSearchSQL"/>
        <if test="structureId != null and structureId.size() > 0">
            AND i.id IN
            <foreach collection="structureId" index="index" item="item" separator="," open="(" close=")">
                #{item.id}
            </foreach>
        </if>
        <include refid="groupBySQL"/>
    </select>

    <select id="checkExistSNP" resultType="boolean">
        SELECT exists(SELECT c.consequencetype
                      FROM fpkm a
                          LEFT JOIN fpkm_associate_snp b ON a.id = b.fpkm_id
                          LEFT JOIN snp_consequencetype c ON c.id = b.snp_id
                      WHERE a.gene_id = #{0} AND c.consequencetype = #{1}) AS result;
    </select>

</mapper>